import{ae as j,af as N,r as M,d as C,s as U,k as x,j as O,x as i,y as f,H as d,B as T,I as e,N as w,C as s,J as p,M as $,K as P,L as z,A as V,ai as I,a9 as E,aJ as B,F as L,a as K,R as G,D as Q,b as W}from"./frappe-ui-CfOnYHud.js";import{_ as A}from"./UserAvatar-NO3477wF.js";import{C as X,t as F,E as Y,c as Z,v as H,k as ee,w as te}from"./index-5_0ocoxz.js";const se={class:"mt-6"},oe={key:0,class:"flex items-center mb-5"},ae={class:"text-lg font-semibold ml-2"},le={class:"flex items-center justify-between mb-2"},re={class:"flex items-center"},ne={class:"text-sm ml-2"},ie={key:1},de={class:"flex justify-between mt-2"},ce=s("span",null,null,-1),q={__name:"DiscussionReplies",props:j({topic:{type:Object,required:!0},singleThread:{type:Boolean,default:!1}},{showTopics:{},showTopicsModifiers:{}}),emits:["update:showTopics"],setup(a){const g=N(a,"showTopics"),b=M(""),n=C("$socket"),k=C("$user"),_=C("$allUsers"),c=a;U(()=>{n.on("publish_message",t=>{r.reload()}),n.on("update_message",t=>{r.reload()}),n.on("delete_message",t=>{r.reload()})});const r=x({url:"lms.lms.utils.get_discussion_replies",cache:["replies",c.topic],makeParams(t){return{topic:c.topic.name}},auto:!0}),o=x({url:"frappe.client.insert",makeParams(t){return{doc:{doctype:"Discussion Reply",reply:b.value,topic:c.topic.name}}}}),h=O(()=>Object.values(_.data).map(y=>({value:y.name,label:y.full_name}))),D=()=>{o.submit({},{validate(){if(!b.value)return"Reply cannot be empty"},onSuccess(){b.value="",r.reload()},onError(t){var y;Z({title:"Error",text:((y=t.messages)==null?void 0:y[0])||t,icon:"x",iconClasses:"bg-red-600 text-white rounded-md p-px",position:"top-center",timeout:10})}})},m=x({url:"frappe.client.set_value",makeParams(t){return{doctype:"Discussion Reply",name:t.name,fieldname:"reply",value:t.reply}}}),v=t=>{m.submit({name:t.name,reply:t.reply},{validate(){if(!t.reply)return"Reply cannot be empty"},onSuccess(){t.editable=!1,r.reload()}})},R=x({url:"frappe.client.delete",makeParams(t){return{doctype:"Discussion Reply",name:t.name}}}),u=t=>{R.submit({name:t.name},{onSuccess(){r.reload()}})};return(t,y)=>(i(),f("div",se,[a.singleThread?$("",!0):(i(),f("div",oe,[d(e(w),{variant:"outline",onClick:y[0]||(y[0]=l=>g.value=!0)},{icon:T(()=>[d(e(X),{class:"w-5 h-5 stroke-1.5 text-gray-700"})]),_:1}),s("span",ae,p(a.topic.title),1)])),(i(!0),f(P,null,z(e(r).data,(l,J)=>(i(),f("div",null,[s("div",{class:L(["py-3",{"border-b":J+1!=e(r).data.length}])},[s("div",le,[s("div",re,[d(A,{user:l.user,class:"mr-2"},null,8,["user"]),s("span",null,p(l.user.full_name),1),s("span",ne,p(e(F)(l.creation)),1)]),e(k).data.name==l.owner&&!l.editable?(i(),V(e(I),{key:0,options:[{label:"Edit",onClick(){l.editable=!0}},{label:"Delete",onClick(){u(l)}}]},{default:T(({open:S})=>[d(e(Y),{class:"w-4 h-4 stroke-1.5 cursor-pointer"})]),_:2},1032,["options"])):$("",!0),l.editable?(i(),f("div",ie,[d(e(w),{variant:"ghost",onClick:S=>v(l)},{default:T(()=>[E(p(t.__("Post")),1)]),_:2},1032,["onClick"]),d(e(w),{variant:"ghost",onClick:S=>l.editable=!1},{default:T(()=>[E(p(t.__("Discard")),1)]),_:2},1032,["onClick"])])):$("",!0)]),d(e(B),{content:l.reply,onChange:S=>l.reply=S,editable:l.editable||!1,fixedMenu:l.editable||!1,editorClass:l.editable?"ProseMirror prose prose-table:table-fixed prose-td:p-2 prose-th:p-2 prose-td:border prose-th:border prose-td:border-gray-300 prose-th:border-gray-300 prose-td:relative prose-th:relative prose-th:bg-gray-100 prose-sm max-w-none":"prose-sm"},null,8,["content","onChange","editable","fixedMenu","editorClass"])],2)]))),256)),d(e(B),{class:"mt-5",content:b.value,mentions:h.value,onChange:y[1]||(y[1]=l=>b.value=l),placeholder:"Type your reply here...",fixedMenu:!0,editorClass:"ProseMirror prose prose-table:table-fixed prose-td:p-2 prose-th:p-2 prose-td:border prose-th:border prose-td:border-gray-300 prose-th:border-gray-300 prose-td:relative prose-th:relative prose-th:bg-gray-100 prose-sm max-w-none border border-gray-300 rounded-b-md min-h-[7rem] py-1 px-2"},null,8,["content","mentions"]),s("div",de,[ce,d(e(w),{onClick:y[2]||(y[2]=l=>D())},{default:T(()=>[s("span",null,p(t.__("Post")),1)]),_:1})])]))}},ue={class:"flex flex-col gap-4"},pe={class:"mb-1.5 text-sm text-gray-600"},me={__name:"DiscussionModal",props:j({title:{type:String,required:!0},doctype:{type:String,required:!0},docname:{type:String,required:!0}},{reloadTopics:{},reloadTopicsModifiers:{}}),emits:["update:reloadTopics"],setup(a){const g=N(a,"reloadTopics"),b=a,n=K({title:"",reply:""}),k=x({url:"frappe.client.insert",makeParams(r){return{doc:{doctype:"Discussion Topic",reference_doctype:b.doctype,reference_docname:b.docname,title:n.title}}}}),_=x({url:"frappe.client.insert",makeParams(r){return{doc:{doctype:"Discussion Reply",topic:r.topic,reply:n.reply}}}}),c=r=>{k.submit({},{validate(){if(!n.title)return"Title cannot be empty.";if(!n.reply)return"Reply cannot be empty."},onSuccess(o){_.submit({topic:o.name},{onSuccess(){n.title="",n.reply="",g.value.reload(),r()}})},onError(o){ee("Error",o.message,"x")}})};return(r,o)=>(i(),V(e(Q),{options:{title:e(H)(b.title),size:"2xl",actions:[{label:"Post",variant:"solid",onClick:h=>c(h)}]}},{"body-content":T(()=>[s("div",ue,[s("div",null,[d(e(G),{modelValue:n.title,"onUpdate:modelValue":o[0]||(o[0]=h=>n.title=h),label:r.__("Title"),type:"text"},null,8,["modelValue","label"])]),s("div",null,[s("div",pe,p(r.__("Details")),1),d(e(B),{content:n.reply,onChange:o[1]||(o[1]=h=>n.reply=h),editable:!0,fixedMenu:!0,editorClass:"prose-sm max-w-none border-b border-x bg-gray-100 rounded-b-md py-1 px-2 min-h-[7rem]"},null,8,["content"])])])]),_:1},8,["options"]))}};function ye(){return window.scrollContainer}const fe={class:"text-xl font-semibold"},be={key:0},ve=["onClick"],he={class:"text-lg font-semibold mb-1"},ge={class:"flex items-center"},_e={class:"text-sm ml-3"},Te={key:1},xe={key:1},ke={key:2,class:"flex flex-col items-center justify-center border-2 border-dashed mt-5 py-8 rounded-md"},we={class:""},Ce={key:0,class:"font-medium mb-2"},$e={class:"text-gray-600"},De={__name:"Discussions",props:{title:{type:String,required:!0},doctype:{type:String,required:!0},docname:{type:String,required:!0},emptyStateTitle:{type:String,default:""},emptyStateText:{type:String,default:"Start a discussion"},singleThread:{type:Boolean,default:!1},scrollToBottom:{type:Boolean,default:!1}},setup(a){const g=M(!0),b=M(null),n=C("$socket"),k=C("$user"),_=M(!1),c=a;U(()=>{k.data&&o.reload(),n.on("new_discussion_topic",m=>{o.refresh()}),c.scrollToBottom&&setTimeout(()=>{r()},100)});const r=()=>{let m=ye();m.scrollTop=m.scrollHeight},o=x({url:"lms.lms.utils.get_discussion_topics",cache:["topics",c.doctype,c.docname],makeParams(){return{doctype:c.doctype,docname:c.docname,single_thread:c.singleThread}}}),h=m=>{g.value=!1,b.value=m},D=()=>{_.value=!0};return(m,v)=>{var R;return i(),f(P,null,[s("div",null,[a.singleThread?$("",!0):(i(),V(e(w),{key:0,class:"float-right",onClick:v[0]||(v[0]=u=>D())},{default:T(()=>[E(p(m.__("New {0}").format(e(H)(a.title))),1)]),_:1})),s("div",fe,p(m.__(a.title)),1)]),(R=e(o).data)!=null&&R.length&&!a.singleThread?(i(),f("div",be,[g.value?(i(!0),f(P,{key:0},z(e(o).data,(u,t)=>(i(),f("div",null,[s("div",{onClick:y=>h(u),class:L(["flex items-center cursor-pointer py-5 w-full",{"border-b":t+1!=e(o).data.length}])},[d(A,{user:u.user,size:"2xl",class:"mr-4"},null,8,["user"]),s("div",null,[s("div",he,p(u.title),1),s("div",ge,[s("span",null,p(u.user.full_name),1),s("span",_e,p(e(F)(u.creation)),1)])])],10,ve)]))),256)):(i(),f("div",Te,[d(q,{topic:b.value,showTopics:g.value,"onUpdate:showTopics":v[1]||(v[1]=u=>g.value=u)},null,8,["topic","showTopics"])]))])):a.singleThread&&e(o).data?(i(),f("div",xe,[d(q,{topic:e(o).data,singleThread:a.singleThread},null,8,["topic","singleThread"])])):(i(),f("div",ke,[d(e(te),{class:"w-7 h-7 text-gray-500 stroke-1.5 mr-2"}),s("div",we,[a.emptyStateTitle?(i(),f("div",Ce,p(m.__(a.emptyStateTitle)),1)):$("",!0),s("div",$e,p(m.__(a.emptyStateText)),1)])])),d(me,{modelValue:_.value,"onUpdate:modelValue":v[2]||(v[2]=u=>_.value=u),title:m.__("New {0}").format(a.title),doctype:c.doctype,docname:c.docname,reloadTopics:e(o),"onUpdate:reloadTopics":v[3]||(v[3]=u=>W(o)?o.value=u:null)},null,8,["modelValue","title","doctype","docname","reloadTopics"])],64)}}};export{De as _};
//# sourceMappingURL=Discussions-DweGYuh1.js.map
